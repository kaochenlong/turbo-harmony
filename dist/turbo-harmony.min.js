/**
 * TurboHarmony v0.0.2
 * (c) 2025 TurboHarmony Contributors
 * @license MIT
 */
/**
 * TurboHarmony - Alpine.js + Turbo Integration
 *
 * A comprehensive adapter that ensures Alpine.js components work seamlessly
 * with Turbo Drive, Turbo Stream, and Turbo Frame updates.
 *
 * @author TurboHarmony Contributors
 * @version 1.0.0
 * @license MIT
 */
class e{constructor(e={}){this.options={debug:!1,logLevel:"warn",preserveState:!1,preserveStateSelectors:["[x-data]"],skipSelectors:[".turbo-harmony-skip",".no-alpine","[data-turbo-harmony-skip]"],reinitDelay:0,batchUpdates:!0,beforeReinit:null,afterReinit:null,onError:null,watchAttributes:["x-data","x-show","x-if","x-for"],autoStart:!0,...e},this.metrics={streamUpdates:0,frameUpdates:0,driveNavigation:0,reinitializations:0,errors:0,performance:[],startTime:performance.now()},this.isInitialized=!1,this.preservedStates=new WeakMap,this.initializedElements=new WeakSet,this.componentLifecycle=new Map,this.handleBeforeVisit=this.handleBeforeVisit.bind(this),this.handleLoad=this.handleLoad.bind(this),this.handleBeforeStreamRender=this.handleBeforeStreamRender.bind(this),this.handleStreamRender=this.handleStreamRender.bind(this),this.handleBeforeFrameRender=this.handleBeforeFrameRender.bind(this),this.handleFrameRender=this.handleFrameRender.bind(this),this.handleError=this.handleError.bind(this),this.options.autoStart&&this.init()}init(){return this.isInitialized?(this.log("warn","TurboHarmony already initialized"),this):(this.validateDependencies(),this.setupEventListeners(),this.isInitialized=!0,this.log("info","TurboHarmony initialized successfully",{options:this.options,version:"1.0.0"}),this)}validateDependencies(){if("undefined"==typeof window)throw new Error("TurboHarmony: window object not available");if(!window.Alpine)throw new Error("TurboHarmony: Alpine.js not found. Please ensure Alpine.js is loaded before TurboHarmony.");if(!window.Turbo)throw new Error("TurboHarmony: Turbo not found. Please ensure @hotwired/turbo is loaded before TurboHarmony.");this.log("debug","Dependencies validated successfully")}setupEventListeners(){document.addEventListener("turbo:before-visit",this.handleBeforeVisit),document.addEventListener("turbo:load",this.handleLoad),document.addEventListener("turbo:before-stream-render",this.handleBeforeStreamRender),document.addEventListener("turbo:stream-render",this.handleStreamRender),document.addEventListener("turbo:before-frame-render",this.handleBeforeFrameRender),document.addEventListener("turbo:frame-render",this.handleFrameRender),window.addEventListener("error",this.handleError),window.addEventListener("unhandledrejection",this.handleError),this.log("debug","Event listeners registered")}handleBeforeVisit(e){this.metrics.driveNavigation++,this.log("debug","Turbo Drive: before visit",{location:e.detail.url}),Alpine.destroyTree&&Alpine.destroyTree(document.body)}handleLoad(e){this.log("debug","Turbo Drive: load complete"),Alpine.initTree&&Alpine.initTree(document.body)}handleBeforeStreamRender(e){this.log("debug","Turbo Stream: before render",{action:e.detail?.action,target:e.detail?.target});const t=this.findTargetElement(e);t&&this.options.preserveState&&this.preserveAlpineState(t)}handleStreamRender(e){const t=performance.now();this.metrics.streamUpdates++;try{const i=this.findTargetElement(e);if(!i)return void this.log("warn","Turbo Stream: target element not found",e.detail);if(this.log("debug","Turbo Stream: render detected",{action:e.detail?.action,target:i.tagName,id:i.id,classes:i.className}),this.shouldSkipElement(i))return void this.log("debug","Turbo Stream: skipping element due to skip selector");this.reinitializeAlpineInElement(i);const r=performance.now();this.metrics.performance.push(r-t)}catch(e){this.handleError(e,"handleStreamRender")}}handleBeforeFrameRender(e){this.log("debug","Turbo Frame: before render",{frame:e.target.id});const t=e.target;if(t){t.querySelectorAll("[x-data]").forEach(e=>{this.initializedElements.delete(e),this.trackComponentLifecycle(e,"beforeDestroy")})}}handleFrameRender(e){this.metrics.frameUpdates++;const t=e.target;this.log("debug","Turbo Frame: render complete",{frame:t.id}),this.shouldSkipElement(t)||this.reinitializeAlpineInElement(t)}findTargetElement(e){return e.target||e.detail?.target||e.detail?.selector&&document.querySelector(e.detail.selector)||null}shouldSkipElement(e){return!e||!e.matches||this.options.skipSelectors.some(t=>{try{return e.matches(t)}catch(e){return this.log("warn",`Invalid skip selector: ${t}`,e),!1}})}reinitializeAlpineInElement(e){this.metrics.reinitializations++;try{this.log("debug","Reinitializing Alpine in element",{tag:e.tagName,id:e.id,classes:e.className}),this.options.beforeReinit&&this.options.beforeReinit(e),this.options.preserveState&&this.preserveAlpineState(e);const t=e.querySelectorAll("[x-data]"),i=[];if(t.forEach(e=>{if(e._x_dataStack&&e._x_dataStack.length>0&&this.initializedElements.has(e))return this.log("debug","Skipping already initialized element",{id:e.id,classes:e.className}),void this.trackComponentLifecycle(e,"skipped");i.push(e),this.trackComponentLifecycle(e,"queued")}),i.length>0){Alpine.destroyTree&&Alpine.destroyTree(e);const t=()=>{Alpine.initTree?Alpine.initTree(e):Alpine.start&&Alpine.start(),i.forEach(e=>{this.initializedElements.add(e),this.trackComponentLifecycle(e,"initialized")}),this.options.preserveState&&this.restoreAlpineState(e),this.options.afterReinit&&this.options.afterReinit(e),this.log("debug","Alpine reinitialization complete",{initialized:i.length})};this.options.reinitDelay>0?setTimeout(t,this.options.reinitDelay):t()}else{const t=e.closest("[x-data]");if(t){this.log("debug","Found parent with x-data, reinitializing from parent");const i=()=>{Alpine.destroyTree&&Alpine.destroyTree(t),Alpine.initTree&&Alpine.initTree(t),this.options.afterReinit&&this.options.afterReinit(e),this.log("debug","Alpine reinitialization from parent complete")};this.options.reinitDelay>0?setTimeout(i,this.options.reinitDelay):i()}else{this.log("debug","No x-data found in parent chain, initializing element directly");const t=()=>{Alpine.initTree&&Alpine.initTree(e),this.options.afterReinit&&this.options.afterReinit(e),this.log("debug","Alpine directive initialization complete")};this.options.reinitDelay>0?setTimeout(t,this.options.reinitDelay):t()}}}catch(e){this.handleError(e,"reinitializeAlpineInElement")}}preserveAlpineState(e){try{const t=e.querySelectorAll(this.options.preserveStateSelectors.join(",")),i=new Map;t.forEach(e=>{if(e._x_dataStack&&e._x_dataStack.length>0)try{const t=this.safeStringify(e._x_dataStack[0]);i.set(this.getElementKey(e),JSON.parse(t))}catch(e){this.log("warn","Failed to preserve state for element",e)}}),this.preservedStates.set(e,i),this.log("debug",`Preserved state for ${i.size} Alpine components`)}catch(e){this.handleError(e,"preserveAlpineState")}}restoreAlpineState(e){try{const t=this.preservedStates.get(e);if(!t)return;setTimeout(()=>{e.querySelectorAll(this.options.preserveStateSelectors.join(",")).forEach(e=>{const i=this.getElementKey(e),r=t.get(i);if(r&&e._x_dataStack&&e._x_dataStack.length>0)try{const t=e._x_dataStack[0];Object.keys(r).forEach(e=>{const i=Object.getOwnPropertyDescriptor(t,e);if(!i||i.set||!1!==i.writable)try{t[e]=r[e]}catch(t){this.log("debug",`Skipped non-writable property: ${e}`)}}),this.log("debug","Restored state for element",i)}catch(e){this.log("warn","Failed to restore state for element",e)}}),this.preservedStates.delete(e)},10)}catch(e){this.handleError(e,"restoreAlpineState")}}getElementKey(e){return e.id||e.getAttribute("data-key")||`${e.tagName}-${Array.from(e.parentNode.children).indexOf(e)}`}safeStringify(e){const t=new WeakSet;return JSON.stringify(e,(e,i)=>{if(!(i instanceof HTMLElement||i instanceof Window||i instanceof Document||i instanceof Event||"function"==typeof i||"string"==typeof e&&e.startsWith("_"))){if("object"==typeof i&&null!==i){if(t.has(i))return;t.add(i)}return i}})}log(e,t,i=null){if(!this.options.debug)return;const r={debug:0,info:1,warn:2,error:3},n=r[this.options.logLevel]||1;if(r[e]>=n){const r=`[TurboHarmony ${(new Date).toISOString()}]`,n="error"===e?"error":"warn"===e?"warn":"info"===e?"info":"log";i?console[n](r,t,i):console[n](r,t)}}handleError(e,t=""){this.metrics.errors++;const i={message:e.message||e,context:t,timestamp:(new Date).toISOString(),metrics:this.getMetrics()};if(this.log("error",`TurboHarmony error in ${t}:`,i),this.options.onError)try{this.options.onError(e,i)}catch(e){console.error("[TurboHarmony] Error in custom error handler:",e)}}trackComponentLifecycle(e,t){const i=this.getElementKey(e),r=performance.now();this.componentLifecycle.has(i)||this.componentLifecycle.set(i,[]),this.componentLifecycle.get(i).push({event:t,timestamp:r,element:{id:e.id,classes:e.className,tag:e.tagName}})}getLifecycleReport(){const e=[];return this.componentLifecycle.forEach((t,i)=>{e.push({component:i,events:t,totalEvents:t.length,duplicateInits:t.filter(e=>"initialized"===e.event).length-1})}),e}getMetrics(){const e=performance.now()-this.metrics.startTime,t=this.metrics.performance.length>0?this.metrics.performance.reduce((e,t)=>e+t)/this.metrics.performance.length:0;return{...this.metrics,uptime:Math.round(e),averageReinitTime:Math.round(100*t)/100,successRate:0===this.metrics.errors?100:Math.round(100*(1-this.metrics.errors/(this.metrics.streamUpdates+this.metrics.frameUpdates+this.metrics.driveNavigation))),totalComponents:this.componentLifecycle.size,lifecycleReport:this.getLifecycleReport()}}resetMetrics(){this.metrics={streamUpdates:0,frameUpdates:0,driveNavigation:0,reinitializations:0,errors:0,performance:[],startTime:performance.now()},this.log("info","Metrics reset")}reinitializeAll(){this.log("info","Manual reinitialization triggered"),this.reinitializeAlpineInElement(document.body)}destroy(){document.removeEventListener("turbo:before-visit",this.handleBeforeVisit),document.removeEventListener("turbo:load",this.handleLoad),document.removeEventListener("turbo:before-stream-render",this.handleBeforeStreamRender),document.removeEventListener("turbo:stream-render",this.handleStreamRender),document.removeEventListener("turbo:before-frame-render",this.handleBeforeFrameRender),document.removeEventListener("turbo:frame-render",this.handleFrameRender),window.removeEventListener("error",this.handleError),window.removeEventListener("unhandledrejection",this.handleError),this.isInitialized=!1,this.log("info","TurboHarmony destroyed")}}"undefined"!=typeof window&&(window.TurboHarmony=e);export{e as TurboHarmony,e as default};
//# sourceMappingURL=turbo-harmony.min.js.map
